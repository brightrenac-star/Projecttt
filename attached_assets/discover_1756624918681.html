<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Society ‚Äî Discover</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f4f8ff; --fg:#0a1223; --muted:#4b5e80; --line:rgba(13,35,78,.14);
  --g1:#7ed3f7; --g2:#a7e8d6; --g3:#cbb7ff; --g4:#b6f2ff;
  --card:#fff; --rad:16px; --shadow:0 10px 28px rgba(16,32,64,.06);
  --nsfw-bg:#ffecef; --nsfw-border:#ffb3b3; --nsfw-fg:#b0172a;
}
*{box-sizing:border-box} html,body{margin:0;height:100%}
body{font-family:Inter,system-ui,Arial;color:var(--fg);background:var(--bg)}
a{color:inherit;text-decoration:none}
button{font:inherit}

/* backdrop */
.backdrop{
  position:fixed; inset:0; z-index:-1;
  background:
    radial-gradient(35% 55% at 15% 10%,  var(--g4) 0%, transparent 65%),
    radial-gradient(40% 60% at 85% 12%,  var(--g1) 0%, transparent 70%),
    radial-gradient(50% 60% at 75% 85%,  var(--g3) 0%, transparent 70%),
    radial-gradient(30% 40% at 0% 90%,   var(--g2) 0%, transparent 60%),
    linear-gradient(180deg, #ffffff 0%, var(--bg) 60%, #ecf4ff 100%);
}
.container{max-width:1120px;margin:0 auto;padding:16px}

/* NAV ‚Äî simplify */
.nav{
  display:flex;align-items:center;justify-content:space-between;gap:12px;
  padding:12px 14px;border-radius:18px;
  border:1px solid var(--line); background:rgba(255,255,255,.9); backdrop-filter:blur(8px)
}
.brand{display:flex;gap:10px;align-items:center}
.logo{
  width:40px;height:40px;border-radius:12px;display:grid;place-items:center;font-weight:900;color:#001018;
  background:conic-gradient(from 210deg,var(--g2),var(--g1),var(--g3),var(--g2));
  box-shadow:0 6px 16px rgba(126,211,247,.25)
}
.actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn{border:none;border-radius:12px;padding:9px 12px;font-weight:800;cursor:pointer}
.btn.pri{background:linear-gradient(135deg,var(--g2),var(--g1));color:#032;border:1px solid rgba(126,211,247,.5);box-shadow:0 8px 18px rgba(126,211,247,.18)}
.btn.ghost{background:#fff;border:1px solid var(--line)}

/* FILTER BAR */
.filters{
  margin-top:14px;
  display:flex;gap:12px;align-items:center;flex-wrap:wrap;
  border:1px solid var(--line);background:#fff;border-radius:16px;padding:14px;box-shadow:var(--shadow)
}
.sel, .input{
  padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;color:var(--fg)
}
.pillset{display:flex;gap:8px;align-items:center}
.pill{
  border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 12px;cursor:pointer;font-weight:800
}
.pill.active{background:linear-gradient(135deg,var(--g2),var(--g1));color:#032;border-color:transparent}

/* Search + Suggest (rightmost) */
.searchwrap{display:flex;gap:10px;align-items:center;margin-left:auto;position:relative}
.search{
  display:flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#fff;min-width:240px
}
.search input{all:unset;width:100%}
.search svg{opacity:.7}
.suggest{
  position:absolute; right:0; top:42px;
  display:none; gap:16px; align-items:flex-start;
  border:1px solid var(--line); background:#fff; border-radius:12px; padding:10px 12px;
  box-shadow:var(--shadow); min-width:380px; z-index:10
}
.suggest.show{display:flex}
.sg-col{flex:1; min-width:170px}
.sg-head{font-weight:800;font-size:12px;margin-bottom:6px;color:#425373}
.sg-item{
  display:flex;align-items:center;gap:8px; padding:6px 8px; border-radius:10px; cursor:pointer;
}
.sg-item:hover{background:#f5f7fc}
.sg-ava{
  width:26px;height:26px;border-radius:999px;background:linear-gradient(135deg,var(--g2),var(--g1));display:grid;place-items:center;font-size:12px;color:#032;font-weight:900;overflow:hidden
}
.sg-ava img{width:100%;height:100%;object-fit:cover;border-radius:999px}
.sg-empty{font-size:12px;color:#8896b0}
.sg-row{display:flex;align-items:center;gap:8px}
.sid{font-size:11px;color:#5b6b87}

/* GRID / CARD */
.grid{
  display:grid; gap:12px; margin-top:12px;
  grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
}
.card{
  border:1px solid var(--line);border-radius:14px;background:#fff;overflow:hidden;box-shadow:var(--shadow);position:relative
}
.card-head{height:82px;background:#f6f8fc;display:flex;align-items:center;justify-content:center;position:relative}
.corner-tag{
  position:absolute; left:8px; top:8px; font-size:10px; padding:3px 6px; border-radius:999px;
  background:var(--nsfw-bg); color:var(--nsfw-fg); border:1px solid var(--nsfw-border); font-weight:900;
}
.avatar{
  width:64px;height:64px;border-radius:999px; border:3px solid #fff; box-shadow:0 2px 10px rgba(14,23,38,.08);
  background:linear-gradient(135deg,var(--g2),var(--g1)); color:#00323a; display:grid;place-items:center; font-weight:800; font-size:20px;
  transform:translateY(28px); overflow:hidden
}
.avatar img{width:100%;height:100%;object-fit:cover;border-radius:999px}
.card-body{padding:14px 12px 12px}
.title-row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.title{font-weight:800}
.sub{color:var(--muted);font-size:13px}
.badge{font-size:11px;padding:6px 10px;border-radius:999px;background:#fff;border:1px solid var(--line);display:inline-flex;gap:6px;align-items:center}
.badge svg{width:14px;height:14px}
.actions{display:flex;gap:8px;margin-top:10px;align-items:center;justify-content:space-between}
.actions .btn{font-size:13px;padding:8px 10px}

/* NSFW mask (when SFW-only) */
.mask{
  position:absolute; inset:0; background:rgba(255,255,255,.65); backdrop-filter:blur(3px);
  display:flex; align-items:center; justify-content:center; font-weight:900; color:#7a0e20; border:1px dashed var(--nsfw-border)
}
.mask .inner{background:#fff; border:1px solid var(--nsfw-border); border-radius:12px; padding:8px 10px;}

/* empty */
.meta{color:var(--muted);font-size:13px}
.empty{margin:20px 0;padding:16px;text-align:center;border:1px dashed var(--line);border-radius:12px;background:#fff}

/* Language bar at bottom */
.langbar{
  margin:14px 0 8px; display:flex; gap:10px; align-items:center; justify-content:flex-end;
}
.langbar .sel{padding:8px 10px}

/* Footer */
.footer{
  margin:12px 0 20px;
  border:1px solid var(--line); border-radius:16px; background:rgba(255,255,255,.9);
  padding:14px; box-shadow:var(--shadow)
}
.footgrid{display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:center}
.footlinks{display:flex; gap:12px; flex-wrap:wrap}
.footlinks a{border:1px solid var(--line); background:#fff; padding:8px 10px; border-radius:999px; font-weight:700; font-size:13px}
.copy{color:var(--muted); font-size:12.5px}

/* Floating Chat Widget (reusable on all pages) */
.chat-fab{
  position:fixed; right:16px; bottom:16px; z-index:99;
  width:54px;height:54px;border-radius:16px;
  background:linear-gradient(135deg,var(--g2),var(--g1));
  border:1px solid rgba(126,211,247,.5);
  box-shadow:0 12px 28px rgba(16,32,64,.16);
  display:grid;place-items:center;cursor:pointer;
}
.chat-fab svg{width:26px;height:26px}
.chat-panel{
  position:fixed; right:16px; bottom:78px; z-index:99; width:320px; max-height:62vh;
  background:#fff; border:1px solid var(--line); border-radius:16px; box-shadow:var(--shadow);
  display:none; overflow:hidden;
}
.chat-panel.show{display:flex;flex-direction:column}
.chat-head{
  padding:10px 12px; display:flex; align-items:center; justify-content:space-between;
  background:linear-gradient(180deg,#fff,#f6fbff); border-bottom:1px solid var(--line); font-weight:800
}
.chat-body{padding:10px; overflow:auto; display:flex; flex-direction:column; gap:8px}
.msg{max-width:80%; padding:8px 10px; border-radius:12px; border:1px solid var(--line); background:#fff}
.msg.me{margin-left:auto; background:linear-gradient(180deg,#f8fbff,#ffffff)}
.chat-input{display:flex; gap:8px; padding:10px; border-top:1px solid var(--line); background:#fff}
.chat-input input{all:unset; flex:1; padding:10px; border:1px solid var(--line); border-radius:10px}
.chat-input button{padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:800}
</style>
</head>
<body>
<div class="backdrop"></div>
<div class="container">

  <!-- NAV -->
  <div class="nav">
    <div class="brand">
      <div class="logo">S</div>
      <div>
        <div style="font-weight:900">Society</div>
        <div class="meta" id="t_sub">Discover creators</div>
      </div>
    </div>
    <div class="actions">
      <a class="btn ghost" href="./index.html" id="t_home">Home</a>
      <a class="btn ghost" href="./settings.html" id="t_settings">Settings</a>
      <button id="connect" class="btn pri">Connect Wallet</button>
    </div>
  </div>

  <!-- FILTERS -->
  <div class="filters">
    <select id="catSel" class="sel" title="Category"><option value=""></option></select>
    <select id="langSel" class="sel" title="Language"><option value=""></option></select>
    <select id="regionSel" class="sel" title="Region">
      <option value="GL">üåê Global</option>
      <option value="NA">üá∫üá∏ North America</option>
      <option value="LATAM">üåé Latin America</option>
      <option value="EU">üá™üá∫ Europe</option>
      <option value="MENA">üåç MENA</option>
      <option value="SSA">üåç Sub-Saharan Africa</option>
      <option value="SA">üåè South Asia</option>
      <option value="SEA">üåè Southeast Asia</option>
      <option value="EAO">üåè East Asia & Oceania</option>
    </select>

    <div class="pillset" role="tablist" aria-label="Sort">
      <button class="pill active" data-sort="trending" id="t_trending">Trending</button>
      <button class="pill" data-sort="new" id="t_new">New</button>
    </div>

    <div class="pillset" aria-label="Content filter">
      <button class="pill" id="sfwOnly">SFW only</button>
      <button class="pill" id="resetFilters">Reset</button>
    </div>

    <!-- Search + Suggest (rightmost) -->
    <div class="searchwrap">
      <label class="search" aria-label="Search by name or SID">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="1.6"/></svg>
        <input id="q" placeholder="Search by name or Society ID‚Ä¶"/>
      </label>
      <div id="suggest" class="suggest" role="listbox" aria-label="Suggestions">
        <div class="sg-col">
          <div class="sg-head" id="t_sg_creators">Creators</div>
          <div id="sgCreators" class="sg-body"></div>
        </div>
        <div class="sg-col">
          <div class="sg-head" id="t_sg_users">Users</div>
          <div id="sgUsers" class="sg-body"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- GRID -->
  <div id="grid" class="grid"></div>
  <div id="empty" class="empty" style="display:none">No creators match your filters.</div>

  <!-- LANGUAGE BAR (bottom) -->
  <div class="langbar">
    <div class="meta" id="t_lang_label" style="margin-right:4px">Language</div>
    <select id="langBottom" class="sel" aria-label="Language">
      <option value="auto">Auto (device)</option>
      <option value="en">English</option>
      <option value="th">‡πÑ‡∏ó‡∏¢</option>
    </select>
  </div>

  <!-- FOOTER -->
  <footer class="footer">
    <div class="footgrid">
      <div class="footlinks">
        <a href="./about.html" id="f_about">About</a>
        <a href="./contact.html" id="f_contact">Contact us</a>
        <a href="./help.html" id="f_help">Help & Safety</a>
        <a href="./terms.html" id="f_terms">Terms</a>
        <a href="./privacy.html" id="f_privacy">Privacy</a>
      </div>
      <div class="copy">¬© <span id="year"></span> Society</div>
    </div>
  </footer>
</div>

<!-- Floating Chat Widget -->
<button class="chat-fab" id="chatFab" aria-label="Open chat">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M21 12a8.5 8.5 0 0 1-8.5 8.5H7l-4 3.5V12A8.5 8.5 0 0 1 21 12Z"/></svg>
</button>
<div class="chat-panel" id="chatPanel" role="dialog" aria-modal="true" aria-label="Chat">
  <div class="chat-head">
    <div>Society Chat</div>
    <button class="btn ghost" id="chatClose">‚úï</button>
  </div>
  <div class="chat-body" id="chatBody"></div>
  <div class="chat-input">
    <input id="chatText" placeholder="Message‚Ä¶"/>
    <button id="chatSend">Send</button>
  </div>
</div>

<script>
/* ===== i18n minimal (EN/TH), control at bottom ===== */
const I18N={en:{
  sub:"Discover creators", home:"Home", settings:"Settings",
  all_cat:"All categories", all_lang:"All languages", region:"Region",
  trending:"Trending", newer:"New", sfw:"SFW only", reset:"Reset",
  search_ph:"Search by name or Society ID‚Ä¶", empty:"No creators match your filters.",
  sg_creators:"Creators", sg_users:"Users", lang_label:"Language",
  f_about:"About", f_contact:"Contact us", f_help:"Help & Safety", f_terms:"Terms", f_privacy:"Privacy"
}, th:{
  sub:"‡∏Ñ‡πâ‡∏ô‡∏û‡∏ö‡∏Ñ‡∏£‡∏µ‡πÄ‡∏≠‡πÄ‡∏ï‡∏≠‡∏£‡πå", home:"‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å", settings:"‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤",
  all_cat:"‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà", all_lang:"‡∏ó‡∏∏‡∏Å‡∏†‡∏≤‡∏©‡∏≤", region:"‡∏†‡∏π‡∏°‡∏¥‡∏†‡∏≤‡∏Ñ",
  trending:"‡∏°‡∏≤‡πÅ‡∏£‡∏á", newer:"‡πÉ‡∏´‡∏°‡πà", sfw:"‡πÄ‡∏â‡∏û‡∏≤‡∏∞ SFW", reset:"‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï",
  search_ph:"‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠ Society ID‚Ä¶", empty:"‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏£‡∏µ‡πÄ‡∏≠‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á",
  sg_creators:"‡∏Ñ‡∏£‡∏µ‡πÄ‡∏≠‡πÄ‡∏ï‡∏≠‡∏£‡πå", sg_users:"‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ", lang_label:"‡∏†‡∏≤‡∏©‡∏≤",
  f_about:"‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÄ‡∏£‡∏≤", f_contact:"‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏£‡∏≤", f_help:"‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠", f_terms:"‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç", f_privacy:"‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß"
}};
function deviceLang(){return (navigator.language||'en').toLowerCase().startsWith('th')?'th':'en'}
function activeLang(){const sel=localStorage.getItem('lang')||'auto';return sel==='auto'?deviceLang():sel}
function tr(){return I18N[activeLang()]||I18N.en}
function applyLang(){
  const L=tr();
  document.getElementById('t_sub').textContent=L.sub;
  document.getElementById('t_home').textContent=L.home;
  document.getElementById('t_settings').textContent=L.settings;
  document.getElementById('t_trending').textContent=L.trending;
  document.getElementById('t_new').textContent=L.newer;
  document.getElementById('sfwOnly').textContent=L.sfw;
  document.getElementById('resetFilters').textContent=L.reset;
  document.getElementById('t_sg_creators').textContent=L.sg_creators;
  document.getElementById('t_sg_users').textContent=L.sg_users;
  document.getElementById('t_lang_label').textContent=L.lang_label;
  document.getElementById('q').placeholder=L.search_ph;
  document.getElementById('empty').textContent=L.empty;
  document.getElementById('f_about').textContent=L.f_about;
  document.getElementById('f_contact').textContent=L.f_contact;
  document.getElementById('f_help').textContent=L.f_help;
  document.getElementById('f_terms').textContent=L.f_terms;
  document.getElementById('f_privacy').textContent=L.f_privacy;
  // first options
  const catSel=document.getElementById('catSel');
  if(catSel.options[0]) catSel.options[0].textContent=L.all_cat;
  const langSel=document.getElementById('langSel');
  if(langSel.options[0]) langSel.options[0].textContent=L.all_lang;
  // sync bottom selector
  document.getElementById('langBottom').value=localStorage.getItem('lang')||'auto';
}
document.getElementById('langBottom').onchange=e=>{ localStorage.setItem('lang', e.target.value); applyLang(); buildCats(); buildLangs(); renderGrid(); };

/* ===== stores & helpers ===== */
const STORE={
  me:['society_me','suiciety_me'],
  posts:['society_posts','suiciety_posts'],
  creators:['society_creators','suiciety_creators'],
  orders:['society_orders','suiciety_orders'],
  users:['society_users','suiciety_users'],
  prefs:['society_prefs','suiciety_prefs'],
  catalog:['society_catalog']
};
const $=s=>document.querySelector(s);
function loadAny(keys,def){ for(const k of keys){ try{ const v=localStorage.getItem(k); if(v!=null) return JSON.parse(v) }catch{} } return def }
function saveOne(key,val){ localStorage.setItem(key, JSON.stringify(val)) }

/* ===== Wallet button ===== */
(function initWalletBtn(){
  const me=loadAny(STORE.me,{wallet:''});
  const btn=$('#connect');
  btn.textContent = me.wallet?('Connected: '+me.wallet):'Connect Wallet';
  btn.onclick=()=>{ const m=loadAny(STORE.me,{wallet:''}); m.wallet = m.wallet?'' : ('0x'+Math.random().toString(16).slice(2,10)+'‚Ä¶'); saveOne(STORE.me[0],m); btn.textContent = m.wallet?('Connected: '+m.wallet):'Connect Wallet'; };
})();

/* ===== Seed demo (with SID for search only) ===== */
function genSID(){ const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; let s=''; for(let i=0;i<15;i++) s+=chars[Math.floor(Math.random()*chars.length)]; return s; }
(function seed(){
  const creators=loadAny(STORE.creators,{});
  const ensure=(h,def)=>{ if(!creators[h]) creators[h]=def; if(!creators[h].sid) creators[h].sid=genSID(); };
  ensure('alice',{handle:'alice',name:'Alice',bio:'Illustrator ‚Ä¢ cozy vibes ‚Ä¢ digital art',avatar:'',banner:'',
    category:'illustration', langs:['en','th'], region:'SEA', nsfw:false,
    tiers:[{id:'bear',name:'Bear',price:2},{id:'bull',name:'Bull',price:5}]});
  ensure('ken',{handle:'ken',name:'Ken',bio:'Streaming ‚Ä¢ casual gaming',avatar:'',banner:'',
    category:'gaming', langs:['en','ja'], region:'EAO', nsfw:false,
    tiers:[{id:'cub',name:'Cub',price:1.2},{id:'tiger',name:'Tiger',price:3.5}]});
  ensure('lena',{handle:'lena',name:'Lena',bio:'Short-form video & vlogs',avatar:'',banner:'',
    category:'video', langs:['en','ko'], region:'EAO', nsfw:false,
    tiers:[{id:'leaf',name:'Leaf',price:1.5},{id:'tree',name:'Tree',price:4.0}]});
  ensure('aom',{handle:'aom',name:'Aom',bio:'Digital artist (18+ content)',avatar:'',banner:'',
    category:'digital-art', langs:['th'], region:'SEA', nsfw:true,
    tiers:[{id:'‡∏´‡∏°‡∏µ',name:'‡∏´‡∏°‡∏µ',price:1.0},{id:'‡πÑ‡∏Å‡πà',name:'‡πÑ‡∏Å‡πà',price:2.5}]});
  ensure('yuta',{handle:'yuta',name:'Yuta',bio:'Street photography',avatar:'',banner:'',
    category:'photography', langs:['ja','en'], region:'EAO', nsfw:false,
    tiers:[{id:'mono',name:'Mono',price:2.2}]});
  ensure('ana',{handle:'ana',name:'Ana',bio:'Fashion & lifestyle (18+ glamor)',avatar:'',banner:'',
    category:'fashion', langs:['es','en'], region:'LATAM', nsfw:true,
    tiers:[{id:'pearl',name:'Pearl',price:1.3},{id:'ruby',name:'Ruby',price:3.9}]});
  saveOne(STORE.creators[0],creators);

  if(!localStorage.getItem(STORE.posts[0]) && !localStorage.getItem(STORE.posts[1])){
    const now=Date.now(); let posts=[];
    const mk=(h,i)=>({id:h+'_'+i, creator:h, text:'post '+i, img:'', createdAt:now-Math.random()*5*24*3600*1000, baseLikes:Math.floor(Math.random()*80)+3, comments:[]});
    Object.keys(creators).forEach(h=>{ const n=6+Math.floor(Math.random()*6); for(let i=0;i<n;i++) posts.push(mk(h,i)); });
    saveOne(STORE.posts[0], posts);
  }

  if(!localStorage.getItem(STORE.users[0]) && !localStorage.getItem(STORE.users[1])){
    const users=[
      {id:'u_tom', name:'Tommy', handle:'tommy.eth', sid: genSID()},
      {id:'u_mai', name:'Mai', handle:'mai.sui', sid: genSID()},
      {id:'u_sara', name:'Sara', handle:'sara_xyz', sid: genSID()},
      {id:'u_nate', name:'Nate', handle:'n8', sid: genSID()},
      {id:'u_bob', name:'Bob', handle:'bobcat', sid: genSID()}
    ];
    saveOne(STORE.users[0], users);
  }

  const orders=loadAny(STORE.orders,[]);
  if(orders.length===0){
    const handles=Object.keys(creators);
    for(let i=0;i<40;i++){
      const h=handles[Math.floor(Math.random()*handles.length)];
      orders.push({id:'o'+i,type:'sub',handle:h,ts:Date.now()-Math.random()*7*24*3600*1000});
    }
    saveOne(STORE.orders[0],orders);
  }

  if(!localStorage.getItem(STORE.catalog[0])){
    const uniqueCats=[...new Set(Object.values(creators).map(c=>c.category))];
    const uniqueLangs=[...new Set([].concat(...Object.values(creators).map(c=>c.langs||[])))];
    saveOne(STORE.catalog[0], { categories: uniqueCats, languages: uniqueLangs });
  }
})();

/* ===== load data ===== */
const creators=loadAny(STORE.creators,{});
const posts=loadAny(STORE.posts,[]);
const orders=loadAny(STORE.orders,[]);
const users=loadAny(STORE.users,[]);
const prefs=loadAny(STORE.prefs,{});
const catalog=loadAny(STORE.catalog,{categories:[],languages:[]});

/* ===== helpers ===== */
function creatorMinPrice(c){
  const T=(c.tiers||[]).map(t=>t.price).filter(p=>typeof p==='number' && p>=0);
  return T.length? Math.min(...T) : 0;
}
function latestPostTs(handle){
  const ts = posts.filter(p=>p.creator===handle).map(p=>p.createdAt);
  return ts.length? Math.max(...ts) : 0;
}
function trendingScore(handle){
  const now=Date.now(); let s=0;
  posts.filter(p=>p.creator===handle).forEach(p=>{
    const hours=(now-p.createdAt)/3600000;
    const decay=1/(1+hours/24);
    const like= (p.baseLikes||0);
    const cmt = (p.comments||[]).length*2;
    s += (like + cmt) * decay;
  });
  return s;
}
function subCount(handle){
  return orders.filter(o=>o.type==='sub' && o.handle===handle).length;
}
function peopleIcon(){
  return `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M16 11a4 4 0 1 0-8 0 4 4 0 0 0 8 0Z"/><path d="M3 21a7 7 0 0 1 18 0"/></svg>`;
}

/* ===== build options from "backend" catalog ===== */
function buildCats(){
  const catSel=$('#catSel'); const L=tr();
  catSel.innerHTML=''; const o0=document.createElement('option'); o0.value=''; o0.textContent=L.all_cat; catSel.appendChild(o0);
  (catalog.categories||[]).forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c.replace(/-/g,' '); catSel.appendChild(o); });
}
function buildLangs(){
  const langSel=$('#langSel'); const L=tr();
  langSel.innerHTML=''; const o0=document.createElement('option'); o0.value=''; o0.textContent=L.all_lang; langSel.appendChild(o0);
  (catalog.languages||[]).forEach(code=>{ const o=document.createElement('option'); o.value=code; o.textContent=code.toUpperCase(); langSel.appendChild(o); });
}
applyLang(); buildCats(); buildLangs();
document.getElementById('year').textContent=new Date().getFullYear();

/* ===== UI state ===== */
const grid=$('#grid'), empty=$('#empty');
const langSel=$('#langSel');
const regionSel=$('#regionSel');
let sortMode='trending';
let qFilter='';
let sfwOnlyActive = (prefs.privacy?.hideNSFW ?? true);

regionSel.value = (prefs.locale?.region)||'GL';

/* sort buttons */
document.querySelectorAll('[data-sort]').forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll('[data-sort]').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active'); sortMode=btn.getAttribute('data-sort'); renderGrid();
  };
});

/* filters change */
[$('#catSel'),langSel,regionSel].forEach(el=>el.addEventListener('input', ()=>renderGrid()));

/* SFW-only & Reset */
const sfwBtn=$('#sfwOnly');
function updateSfwBtn(){ sfwBtn.classList.toggle('active', sfwOnlyActive); }
sfwBtn.onclick=()=>{ sfwOnlyActive=!sfwOnlyActive; updateSfwBtn(); renderGrid(); };
updateSfwBtn();

$('#resetFilters').onclick=()=>{
  $('#catSel').value=''; langSel.value=''; qFilter=''; $('#q').value='';
  regionSel.value = (prefs.locale?.region)||'GL';
  sfwOnlyActive = (prefs.privacy?.hideNSFW ?? true);
  updateSfwBtn();
  renderGrid();
};

/* search + suggest ‚Äî prefer SID over name (but SID not shown on cards) */
const qInp=$('#q');
const suggestBox=$('#suggest');
const sgCreators=$('#sgCreators');
const sgUsers=$('#sgUsers');

qInp.placeholder = tr().search_ph;

qInp.addEventListener('input', ()=>{
  const q=(qInp.value||'').trim().toLowerCase();
  qFilter = q;
  updateSuggest(q);
  suggestBox.classList.toggle('show', q.length>0);
});
qInp.addEventListener('keydown', (e)=>{
  if(e.key==='Enter'){
    e.preventDefault();
    renderGrid();
    suggestBox.classList.remove('show');
  }
});
document.addEventListener('click', (e)=>{
  if(!suggestBox.contains(e.target) && !qInp.closest('.search').contains(e.target)){
    suggestBox.classList.remove('show');
  }
});

function scoreQuery(target, q){
  if(!q) return 0;
  const t=(target||'').toLowerCase();
  if(t===q) return 5;
  if(t.startsWith(q)) return 4;
  if(t.includes(q)) return 2;
  return 0;
}
function rankCreators(q){
  if(!q) return [];
  const list=Object.values(creators).map(c=>{
    const sName=Math.max(scoreQuery(c.name,q),scoreQuery(c.handle,q));
    const sSID=scoreQuery(c.sid||'', q)*2; // weight SID higher
    const boost = (regionSel.value && regionSel.value!=='GL' && c.region===regionSel.value) ? 0.5 : 0;
    return {c, score:sName+sSID+boost};
  }).filter(x=>x.score>0);
  list.sort((a,b)=>{
    if(b.score!==a.score) return b.score-a.score;
    return trendingScore(b.c.handle)-trendingScore(a.c.handle);
  });
  return list.map(x=>x.c).filter(c=>!sfwOnlyActive || !c.nsfw).slice(0,6);
}
function rankUsers(q){
  if(!q) return [];
  const list=(users||[]).map(u=>{
    const sName=Math.max(scoreQuery(u.name,q),scoreQuery(u.handle,q));
    const sSID=scoreQuery(u.sid||'', q)*2;
    return {u, score:sName+sSID};
  }).filter(x=>x.score>0);
  list.sort((a,b)=>b.score-a.score);
  return list.slice(0,6).map(x=>x.u);
}
function updateSuggest(q){
  sgCreators.innerHTML='';
  sgUsers.innerHTML='';
  const C=rankCreators(q);
  const U=rankUsers(q);
  if(C.length===0) sgCreators.innerHTML = `<div class="sg-empty">No matches</div>`;
  if(U.length===0) sgUsers.innerHTML = `<div class="sg-empty">No matches</div>`;
  C.forEach(c=>{
    const row=document.createElement('div'); row.className='sg-item';
    const ava=c.avatar? `<img src="${c.avatar}" class="sg-ava" alt="">` : `<div class="sg-ava">${(c.name||c.handle)?.[0]?.toUpperCase()}</div>`;
    row.innerHTML = `
      ${ava}
      <div class="sg-row">
        <div>
          <div style="font-weight:800">${c.name||c.handle}</div>
          <div class="sid">SID: ${c.sid||'‚Äî'}</div>
        </div>
      </div>`;
    row.onclick=()=>{ window.location.href = `./creator.html?h=${c.handle}`; };
    sgCreators.appendChild(row);
  });
  U.forEach(u=>{
    const row=document.createElement('div'); row.className='sg-item';
    row.innerHTML = `<div class="sg-ava">${(u.name||'U')?.[0]?.toUpperCase()}</div>
      <div><div style="font-weight:800">${u.name}</div><div class="sid">SID: ${u.sid||'‚Äî'}</div></div>`;
    row.onclick=()=>{ qInp.value = u.sid || u.name; renderGrid(); suggestBox.classList.remove('show'); };
    sgUsers.appendChild(row);
  });
}

/* card renderer (SID removed from UI here) */
function creatorCard(c){
  const subs = subCount(c.handle);
  const price = creatorMinPrice(c);
  const stat = price>0 ? `from ${price} SUI/mo` : 'Free';
  const ava = c.avatar ? `<img src="${c.avatar}" alt="">` : (c.name?.[0]?.toUpperCase() || 'C');
  return `
    <div class="card" data-h="${c.handle}">
      <div class="card-head">
        ${c.nsfw?`<div class="corner-tag" title="18+">NSFW</div>`:''}
        <div class="avatar">${c.avatar?`<img src="${c.avatar}" alt="">`:ava}</div>
        ${ (sfwOnlyActive && c.nsfw) ? `<div class="mask"><div class="inner">18+ ‚Ä¢ Hidden</div></div>` : '' }
      </div>
      <div class="card-body">
        <div class="title-row">
          <div class="title">${c.name||c.handle}</div>
        </div>
        <div class="sub" style="margin-top:2px">
          ${(c.category||'').replace(/-/g,' ')} ‚Ä¢ ${(c.langs||[]).join(', ').toUpperCase()||'‚Äî'} ‚Ä¢ ${c.region||'GL'}
        </div>
        <div class="actions">
          <a class="btn ghost" href="./creator.html?h=${c.handle}">View</a>
          <div style="display:flex;gap:6px;align-items:center">
            <span class="badge" title="Subscribers">${peopleIcon()} ${subs}</span>
            <span class="badge">${stat}</span>
          </div>
        </div>
      </div>
    </div>
  `;
}

/* grid filters */
function passesFilters(c){
  const cat=$('#catSel').value;
  const lang=langSel.value;
  const reg=regionSel.value;
  if(cat && (c.category||'')!==cat) return false;
  if(lang && !(c.langs||[]).includes(lang)) return false;
  if(reg && reg!=='GL' && c.region!==reg) return false;
  if(sfwOnlyActive && c.nsfw) return false;
  if(qFilter){
    const q=qFilter;
    const nm=(c.name||'').toLowerCase(), hd=(c.handle||'').toLowerCase(), sid=(c.sid||'').toLowerCase();
    if(!(nm.includes(q)||hd.includes(q)||sid.includes(q))) return false;
  }
  return true;
}
function sortCreators(list){
  if(sortMode==='new'){
    return list.sort((a,b)=> latestPostTs(b.handle)-latestPostTs(a.handle));
  }
  return list.sort((a,b)=>{
    const rb=(regionSel.value!=='GL' && b.region===regionSel.value)?1.05:1;
    const ra=(regionSel.value!=='GL' && a.region===regionSel.value)?1.05:1;
    return trendingScore(b.handle)*rb - trendingScore(a.handle)*ra;
  });
}

/* render grid */
function renderGrid(){
  let list = Object.values(creators).filter(passesFilters);
  list = sortCreators(list);
  grid.innerHTML='';
  if(list.length===0){ empty.style.display='block'; return; }
  empty.style.display='none';
  list.forEach(c=>{
    const wrap=document.createElement('div'); wrap.innerHTML=creatorCard(c);
    grid.appendChild(wrap.firstElementChild);
  });
}

/* init */
applyLang();
renderGrid();

/* ===== Floating Chat Widget (local demo) ===== */
const CHAT_KEY='society_chat';
function loadChat(){ try{return JSON.parse(localStorage.getItem(CHAT_KEY)||'[]')}catch{return[]} }
function saveChat(L){ localStorage.setItem(CHAT_KEY, JSON.stringify(L)) }
const chatFab=$('#chatFab'), chatPanel=$('#chatPanel'), chatBody=$('#chatBody'), chatText=$('#chatText');
function renderChat(){
  chatBody.innerHTML='';
  const L=loadChat();
  L.forEach(m=>{
    const div=document.createElement('div'); div.className='msg'+(m.me?' me':''); div.textContent=m.text; chatBody.appendChild(div);
  });
  chatBody.scrollTop = chatBody.scrollHeight;
}
function openChat(){ chatPanel.classList.add('show'); renderChat(); chatText.focus(); }
function closeChat(){ chatPanel.classList.remove('show'); }
function sendChat(){
  const t=(chatText.value||'').trim(); if(!t) return;
  const L=loadChat(); L.push({me:true, text:t, ts:Date.now()}); saveChat(L); chatText.value=''; renderChat();
  setTimeout(()=>{ const L2=loadChat(); L2.push({me:false, text:"(Demo) Thanks! Real-time messaging coming soon.", ts:Date.now()}); saveChat(L2); renderChat(); }, 500);
}
chatFab.onclick=openChat; document.getElementById('chatClose').onclick=closeChat;
document.getElementById('chatSend').onclick=sendChat;
chatText.addEventListener('keydown',e=>{ if(e.key==='Enter') sendChat(); });
</script>
</body>
</html>
